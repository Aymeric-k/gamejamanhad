<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>
    <h2 class="score">SCORE : 0</h2>
    <h2 id="timer">TIMER: 3:00 </h2>
    <h2 id="message"></h2>

    <script>
        let x = (Math.random() * 1800) + 20;
        let y = (Math.random() * 920) + 20;
        let xx;
        let yy;
        let centerX = 1920 / 2
        let centerY = 920 / 2
        let maxPixelDifference = 20;
        let differenceXBoatWave;
        let differenceYBoatWave;
        let differenceXBoatPort;
        let differenceYBoatPort;
        let wave;
        let boat;
        let port;
        let score = 0;
        let follow = false;
        let xAxis;
        let yAxis;
        let randomSide = Math.round(Math.random() * 4);
        let gamepad;
        let vitesse = 10;
        const boatsData = [
    { scale: 0.1, speedThreshold: [11, 80], waveScale: 0.4, phase:1, priority: 1 },
    {scale: 0.2, speedThreshold: [16, 70], waveScale: 0.45, phase:1,  priority: 1},
    {scale: 0.3, speedThreshold: [31, 86], waveScale: 0.50, phase:1,  priority: 0},
    {scale: 0.4, speedThreshold: [16, 81], waveScale: 0.55, phase:2,  priority: 0},
    {scale: 0.5, speedThreshold: [41, 85], waveScale: 0.60, phase:2,  priority: 0},
    {scale: 0.55, speedThreshold: [11, 60], waveScale: 0.65, phase:2, priority: 1},
    {scale: 0.60, speedThreshold: [31, 70], waveScale: 0.70,phase:2,  priority: 1},
    {scale: 0.65, speedThreshold: [46, 80], waveScale: 0.75, phase:2, priority: 0},
    {scale: 0.70, speedThreshold: [36, 65], waveScale: 0.80, phase:2, priority: 1},
    {scale: 0.75, speedThreshold: [31, 50], waveScale: 0.85, phase:2, priority: 0},
    {scale: 0.80, speedThreshold: [41, 60], waveScale: 0.90, phase:2, priority: 0},
    {scale: 0.85, speedThreshold: [76, 85], waveScale: 0.95, phase:3, priority: 1}

    ]
        switch (randomSide) {
            case 1:
                yy = 0 + 30
                xx = Math.random() * 1800 + 30
            case 2:
                yy = 920
                xx = Math.random() * 1800 + 30
                break;
            case 3:
                xx = 0 + 50
                yy = Math.random() * 920 + 30
                break;
            case 4:
                xx = 1800
                yy = Math.random() * 920 + 30
                break;
            default:
                break;
        }

        let currentSide = randomSide;

        function preload() {

            this.load.image('boat1', '/assets/img/boat1.png');
            // this.load.image('boat2', '/assets/img/boat2.png');
            // this.load.image('boat3', '/assets/img/boat3.png');
            // this.load.image('boat4', '/assets/img/boat4.png');
            // this.load.image('boat5', '/assets/img/boat5.png');
            // this.load.image('boat6', '/assets/img/boat6.png');
            // this.load.image('boat7', '/assets/img/boat7.png');
            // this.load.image('boat8', '/assets/img/boat8.png');
            // this.load.image('boat9', '/assets/img/boat9.png');
            // this.load.image('boat10', '/assets/img/boat10.png');
            // this.load.image('boat11', '/assets/img/boat11.png');
            // this.load.image('boat12', '/assets/img/boat12.png');
            // this.load.image('boat13', '/assets/img/boat13.png');
            this.load.image('sea', '/assets/img/sea.jpg');
            this.load.image('wave', '/assets/img/wave.png');
            this.load.image('port', '/assets/img/port.png');
            this.load.image('baril', '/assets/img/baril.png');
            // this.load.image('')


        }

        function create() {

            this.input.gamepad.once('connected', function (pad) {
                gamepad = pad;
            });
            sea = this.add.image(-5, -5, 'sea')
            wave = this.physics.add.image(centerX, centerY, 'wave')
            wave.setScale(0.4)
            boat = this.physics.add.image(x, y, 'boat1');
            boat.setScale(0.1);
            port = this.physics.add.image(xx, yy, 'port');
            wave.setCollideWorldBounds(true);
            wave.onWorldBounds = true;
            wave.body.setSize(80, 80, 10, 10);
            sea.setScale(0.8)

        }


        let config = {
            type: Phaser.WEBGL, // Définit le moteur graphique à utilisé CANVAS, WEBGL ou AUTO.
            width: window.innerWidth,
            height: window.innerHeight,
            physics: {
                default: 'arcade',
                arcade: { debug: false }
            }, // définit la physique utiliser par phaser
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            input: {
                gamepad: true  // Activez ici le gamepad
            }// configure la scene utiliser pour phaser.
        };

        const game = new Phaser.Game(config);




        function update() {

            calculBoatWave();
            if (gamepad) {
                if (gamepad.axes.length >= 2) {
                    xAxis = gamepad.axes[0].getValue();
                    yAxis = gamepad.axes[1].getValue();

                    wave.x += xAxis * vitesse;
                    wave.y += yAxis * vitesse;
                    if (xAxis < 0) {
                        // Si vous allez vers la gauche
                        // retourner le bateau
                        wave.flipX = true;  // retourner la vague
                    } else if (xAxis > 0) {
                        // Si vous allez vers la droite
                        // ne pas retourner le bateau
                        boat.flipX = false;
                        wave.flipX = false; // ne pas retourner la vague
                    }
                }
            }
            if (Math.abs(differenceXBoatWave) <= 20 && Math.abs(differenceYBoatWave) <= 20) {
                vitesse = 5;
                follow = true;

                let distance = Math.sqrt(differenceXBoatWave * differenceXBoatWave + differenceYBoatWave * differenceYBoatWave);

                // Si le bateau est très proche de la vague, arrêtez de le déplacer
                if (distance <= 10) return;
                if (xAxis < 0) {
                    // Si vous allez vers la gauche
                    // retourner le bateau
                    boat.flipX = true;  // retourner la vague
                } else if (xAxis > 0) {
                    // Si vous allez vers la droite
                    // ne pas retourner le bateau
                    boat.flipX = false; // ne pas retourner la vague
                }

                let normalizedDiffX = differenceXBoatWave / distance;
                let normalizedDiffY = differenceYBoatWave / distance;

                // Multipliez d'abord par la vitesse, puis arrondissez
                let moveX = Math.round(normalizedDiffX * 11);
                let moveY = Math.round(normalizedDiffY * 11);

                boat.x += moveX;
                boat.y += moveY;
                calculBoatPort()
                if (Math.abs(differenceXBoatPort) <= 20 && Math.abs(differenceYBoatPort) <= 20) {
                    follow = false
                    arrived();
                }
            } else {
                follow = false
                boat.x++
                boat.y++
                boat.flipX = false;

            }

            if (boat.x > game.config.width + boat.width) {
                boat.x = 0;

            } else if (boat.y > game.config.height + boat.height) {
                boat.y = 0;
            }
            updateCountdown();
        }
        function calculBoatWave() {
            differenceXBoatWave = wave.x - boat.x;
            differenceYBoatWave = wave.y - boat.y;


        }
        function arrived() {
            score += 10;
            const scoreBox = document.querySelector('.score');
            scoreBox.innerHTML = "Score : " + score;
            while (randomSide === currentSide) {
                randomSide = Math.floor(Math.random() * 4) + 1;  // Génère un nouveau côté aléatoire
            }
            calculBoatWave();
            follow = false;
            vitesse = 10;
            switch (randomSide) {
                case 1:
                    yy = 0 + port.height
                    xx = (Math.random() * 1800) + port.width
                    break;
                case 2:
                    yy = game.config.height - 50
                    xx = (Math.random() * 1800) + port.width
                    break;
                case 3:
                    xx = 0 + port.width
                    yy = Math.random() * 920 + port.height
                    break;
                case 4:
                    xx = game.config.width - 50
                    yy = Math.random() * 920 + port.height
                    break;
                default:
                    break;
            }
            currentSide = randomSide;
            port.x = xx
            port.y = yy
            boat.x = Math.random() * (game.config.width - boat.width);
            boat.y = Math.random() * (game.config.height - boat.height);
        }

        function calculBoatPort() {
            differenceXBoatPort = port.x - boat.x;
            differenceYBoatPort = port.y - boat.y;
        }
        const countdownElement = document.getElementById('timer');
        let time = 3 * 3600;  // 3 minutes

        function updateCountdown() {
            const minutes = Math.floor(time / 60);
            const seconds = time % 60;

            const formattedSeconds = seconds < 10 ? `0${seconds}` : seconds;

            countdownElement.innerHTML = `TIMER: ${minutes}:${formattedSeconds}`;

            if (time > 0) {
                time--;
            } else {
                clearInterval(interval);
                countdownElement.innerHTML = 'TIMER: 00:00';

                const messageElement = document.getElementById('message');
                if (messageElement) {
                    messageElement.innerHTML = 'Temps Écoulé!';
                }
            }
        }
    </script>

</body>

</html>